<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>European Capitals Map</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css" rel="stylesheet" />
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCpgbO0B6V0eEiVfyt6xewv0cHjyYsj1-o&libraries=places"></script>
  <style>
    body { margin:0; padding:0; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
    .marker {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 5px solid white;
      background-size: cover;
      background-position: center;
    }
    #addPinForm {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 5px;
      z-index: 1;
    }
  </style>
</head>
<body>
<div id="map"></div>
<div id="addPinForm">
  <input type="text" id="searchInput" placeholder="Search for a place">
  <button onclick="searchPlace()">Search</button>
  <input type="text" id="city" placeholder="City" readonly>
  <input type="text" id="country" placeholder="Country" readonly>
  <input type="text" id="latitude" placeholder="Latitude" readonly>
  <input type="text" id="longitude" placeholder="Longitude" readonly>
  <input type="text" id="imageUrl" placeholder="Image URL">
  <button onclick="addPin()">Add Pin</button>
</div>
<script>
  mapboxgl.accessToken = 'pk.eyJ1IjoiZGphbmRlcmEiLCJhIjoiY2ptZzJ4NXhqMnJ4ZjNrbnRiMm1haHhrcSJ9.8U9iRQu8sGnE7AQ1C7VI4Q'; // Nahraďte vaším Mapbox Access Tokenem

  var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v11',
    center: [10, 50], // Přibližný střed Evropy
    zoom: 4
  });

  function initClient() {
    gapi.client.init({
      'apiKey': 'AIzaSyCpgbO0B6V0eEiVfyt6xewv0cHjyYsj1-o',
      'clientId': '395067695962-v8pkp8fcr8lh6hop46krd1kjj76753pp.apps.googleusercontent.com',
      'scope': 'https://www.googleapis.com/auth/spreadsheets',
      'discoveryDocs': ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
    }).then(function () {
      console.log('Google API initialized');
      loadPins();
    });
  }

  function loadPins() {
    const spreadsheetId = '1YtHqKg22xPXglCKOYOzCYTK4Om1_WhjaogZTCHnfzf8';
    const range = 'mapa!A:E';

    gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: spreadsheetId,
      range: range,
    }).then(response => {
      const rows = response.result.values;
      rows.slice(1).forEach(function(row) { // Skip header row
        const [city, country, lat, lng, imageUrl] = row;
        const coordinates = [parseFloat(lng), parseFloat(lat)];

        // Vytvořte DOM element pro každý marker
        var el = document.createElement('div');
        el.className = 'marker';
        el.style.backgroundImage = 'url(' + imageUrl + ')';

        // Vytvořte marker a přidejte do mapy
        new mapboxgl.Marker(el)
          .setLngLat(coordinates)
          .addTo(map);

        // Přidání vyskakovacího okna s popisem
        el.addEventListener('click', function() {
          new mapboxgl.Popup()
            .setLngLat(coordinates)
            .setHTML(`<strong>${city}, ${country}</strong>`)
            .addTo(map);
        });
      });
    });
  }

  function searchPlace() {
    const input = document.getElementById('searchInput').value;
    const service = new google.maps.places.PlacesService(document.createElement('div'));

    service.textSearch({ query: input }, function(results, status) {
      if (status === google.maps.places.PlacesServiceStatus.OK) {
        const place = results[0];
        document.getElementById('city').value = place.name;
        document.getElementById('country').value = place.formatted_address;
        document.getElementById('latitude').value = place.geometry.location.lat();
        document.getElementById('longitude').value = place.geometry.location.lng();
      } else {
        alert('Place not found');
      }
    });
  }

  function addPin() {
    const city = document.getElementById('city').value;
    const country = document.getElementById('country').value;
    const lat = document.getElementById('latitude').value;
    const lng = document.getElementById('longitude').value;
    const imageUrl = document.getElementById('imageUrl').value;

    const row = [city, country, lat, lng, imageUrl];

    const params = {
      spreadsheetId: '1YtHqKg22xPXglCKOYOzCYTK4Om1_WhjaogZTCHnfzf8',
      range: 'mapa!A:E',
      valueInputOption: 'RAW',
      insertDataOption: 'INSERT_ROWS',
    };

    const valueRangeBody = {
      "range": "mapa!A:E",
      "majorDimension": "ROWS",
      "values": [
        row
      ],
    };

    gapi.client.sheets.spreadsheets.values.append(params, valueRangeBody).then(response => {
      console.log(response);
      loadPins();
    });
  }

  gapi.load('client:auth2', initClient);
</script>
</body>
</html>
